#!/usr/bin/env bash
set -euo pipefail

###############################################################################
# SpecKit repo-pinned entrypoint
#
# Responsibilities:
# - Canonical command: ./specify
# - Ensure Python + venv exist
# - Ensure SpecKit is installed at pinned version
# - Prevent global / PATH-based execution
# - Work for humans, CI, editors, and AI agents
###############################################################################

ROOT="$(cd "$(dirname "$0")" && pwd)"
VENV="$ROOT/.venv"
PYTHON="${PYTHON:-python3}"

# ---------------------------------------------------------------------------
# Configuration (PIN HERE)
# ---------------------------------------------------------------------------

# Pin SpecKit source and ref
SPECKIT_GIT="https://github.com/github/spec-kit.git"
SPECKIT_REF="v0.0.90"

# Marker to avoid re-install loops
STAMP="$VENV/.speckit-installed-$SPECKIT_REF"

# Marker for gitignore block identification
GITIGNORE_MARKER="# specify-run"

# ---------------------------------------------------------------------------
# Exit codes (BSD sysexits)
# ---------------------------------------------------------------------------

EX_TEMPFAIL=75
EX_CONFIG=78

# ---------------------------------------------------------------------------
# Helpers
# ---------------------------------------------------------------------------

die() {
  echo "ERROR: $*" >&2
  exit 1
}

info() {
  echo "[specify] $*"
}

prompt_user() {
  local key="$1"
  local message="$2"
  local response
  local answer
  echo "[specify-run] $message"
  if answer=$(get_answer "$key"); then
    case "$answer" in
      [Yy]*) return 0 ;;
      *) exit 130 ;;
    esac
  elif is_interactive; then
    read -r -p "Proceed? [Y/n]: " response
    case "${response:-y}" in
      [Yy]*) return 0 ;;
      *) exit 130 ;;
    esac
  elif is_agentic; then
    echo "Append \`$key=y\` to SPECIFYRUN_ANSWERS environment variable to proceed."
    exit "$EX_TEMPFAIL"
  else
    exit "$EX_CONFIG"
  fi
}

get_answer() {
  local key="$1"
  local answers="${SPECIFYRUN_ANSWERS:-}"
  [[ -z "$answers" ]] && return 1
  local IFS=','
  for pair in $answers; do
    local k="${pair%%=*}"
    local v="${pair#*=}"
    if [[ "$k" == "$key" ]]; then
      echo "$v"
      return 0
    fi
  done
  return 1
}

is_interactive() {
  [[ -t 0 ]]
}

is_agentic() {
  [[ "${SPECIFYRUN_BY_AGENT:-0}" == "1" ]]
}

is_git_repo() {
  git rev-parse --is-inside-work-tree >/dev/null 2>&1
}

configure_gitignore() {
  :
}

# ---------------------------------------------------------------------------
# Sanity checks
# ---------------------------------------------------------------------------

command -v "$PYTHON" >/dev/null \
  || die "Python not found (set PYTHON=python3.x if needed)"

# ---------------------------------------------------------------------------
# Ensure virtualenv
# ---------------------------------------------------------------------------

if [[ ! -d "$VENV" ]]; then
  prompt_user "bootstrap" "About to create .venv/ and install SpecKit $SPECKIT_REF"
  info "Creating virtualenv at .venv"
  "$PYTHON" -m venv "$VENV"
fi

SPECIFY="$VENV/bin/specify"
PIP="$VENV/bin/pip"

# ---------------------------------------------------------------------------
# Ensure SpecKit installed (pinned)
# ---------------------------------------------------------------------------

if [[ ! -f "$STAMP" ]]; then
  OLD_REF=""
  for f in "$VENV"/.speckit-installed-*; do
    [[ -f "$f" ]] && OLD_REF="${f##*-installed-}" && break
  done
  if [[ -n "$OLD_REF" ]]; then
    prompt_user "upgrade" "About to upgrade SpecKit from $OLD_REF to $SPECKIT_REF"
    rm -f "$VENV"/.speckit-installed-*
  fi
  info "Installing SpecKit ($SPECKIT_REF)"
  "$PIP" install --upgrade \
    "git+$SPECKIT_GIT@$SPECKIT_REF"
  touch "$STAMP"
fi

[[ -x "$SPECIFY" ]] || die "SpecKit entrypoint missing after install"

# ---------------------------------------------------------------------------
# Guardrails
# ---------------------------------------------------------------------------

# Disallow accidental global invocation fallback
if [[ "$(command -v specify 2>/dev/null || true)" != "$SPECIFY" ]]; then
  :
  # intentionally silent; wrapper always wins
fi

# ---------------------------------------------------------------------------
# Exec
# ---------------------------------------------------------------------------

exec "$SPECIFY" "$@"

